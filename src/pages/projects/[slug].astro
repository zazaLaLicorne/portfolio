---
import { Image } from "astro:assets";
import projects from "@/data/projects.json";
import ProjectsLayout from "@/layouts/ProjectsLayout.astro";
import Button from "@/components/Button.astro";
import { getTechIcon } from "@/lib/techIcons";


// G√©n√©rer toutes les routes statiques
export function getStaticPaths() {
  return projects.map((projet) => ({
    params: { slug: projet.slug },
    props: { projet },
  }));
}

// R√©cup√©rer le projet depuis les props
const { projet } = Astro.props;

if (!projet) {
  throw new Error(`Projet introuvable`);
}

function badgeColor(score) {
  const val = Number(score);
  if (val >= 90) return "bg-green-500 text-white";
  if (val >= 50) return "bg-yellow-500 text-black";
  return "bg-red-500 text-white";
}

const hasSecurityHeaders = Boolean(projet.scores?.security_headers);

const hasLighthouseDesktop = projet.scores?.lighthouse?.desktop &&
  Object.values(projet.scores.lighthouse.desktop)
    .some(v => v !== null && v !== "" && v !== undefined);

const hasLighthouseMobile = projet.scores?.lighthouse?.mobile &&
  Object.values(projet.scores.lighthouse.mobile)
    .some(v => v !== null && v !== "" && v !== undefined);

const hasAnyScore = hasSecurityHeaders || hasLighthouseDesktop || hasLighthouseMobile;

// Pour la date plus lisible
const date = new Date(projet.date).toLocaleDateString("fr-FR", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const videosList = [
  projet.videos?.desktop,
  projet.videos?.tablet?.landscape,
  projet.videos?.tablet?.portrait,
  projet.videos?.mobile?.landscape,
  projet.videos?.mobile?.portrait
].filter(Boolean);

const hasOneVideo = videosList.length === 1;

function toEmbed(url) {
  if (!url) return "";

  if (url.includes("/shorts/")) {
    return url.replace("youtube.com/shorts/", "www.youtube.com/embed/");
  }

  if (url.includes("youtu.be/")) {
    return url.replace("youtu.be/", "www.youtube.com/embed/");
  }

  if (url.includes("watch?v=")) {
    return url.replace("watch?v=", "embed/");
  }

  return url;
}
---

<!-- PAGE PROJET -->
<ProjectsLayout>    
<div class="project-page">

  <div data-aos="fade-up" class="max-w-4xl mt-10 pt-10 mx-auto">

    <!-- Titre + badge -->
    <h1 class="text-4xl text-center font-bold mb-4">{projet.title}</h1>

   {projet.badge && (
  <div class="flex justify-center">
    <span class="inline-block bg-accent text-white px-3 py-1 rounded-lg mb-6">
      {projet.badge}
    </span>
  </div>
)}

    <p class="opacity-80 mb-10 text-center text-sm">
      Projet publi√© le {date}
    </p>

    <!-- Thumbnail -->
    <div data-aos="zoom-in" class="rounded-xl overflow-hidden shadow-lg mb-12">
      <Image
        src={projet.thumbnail}
        alt={projet.title}
        width={1200}
        height={700}
        loading="eager"
        class="w-full h-auto object-cover"
      />
    </div>

    <!-- Description -->
   <div data-aos="fade-up" class="project-description mb-12" set:html={projet.description}>

   </div>

    <!-- Tech Stack -->
    <div data-aos="fade-up" class="mb-16">
      <h2 class="text-2xl font-semibold text-center mb-4">Technologies utilis√©es</h2>
      <div class="flex flex-wrap justify-center gap-6">
        {projet.techs.map((tech) => (
          <div class="flex flex-col gap-3 items-center" data-aos="zoom-in" data-aos-delay="100">
            <Image
              src={getTechIcon(tech)}
              alt={tech}
              width={40}
              height={40}
              class="w-10 h-10 object-contain"
              loading="lazy"
            />
            <span class="text-lg">{tech}</span>
          </div>
        ))}
      </div>
    </div>
        <!-- Liens externes -->
   {(projet.project_url || projet.github_url) && (
  <div data-aos="fade-up" class="flex flex-col text-center gap-6 mb-20">
    <h2 class="text-2xl font-semibold mb-4">Liens du projet</h2>

    {projet.project_url && (
      <Button variant="projet" href={projet.project_url} target="_blank">
        Voir le site
      </Button>
    )}

    {projet.github_url && (
      <Button variant="projet" href={projet.github_url} target="_blank">
        <img src="/icons/github.webp" alt="GitHub" class="w-5 h-5" />
        Voir le code
      </Button>
    )}
  </div>
)}

<!-- Scores du projet -->
{hasAnyScore && (

  <div class="mt-20" data-aos="fade-up">
    <h2 class="text-2xl font-semibold text-center mb-10">Scores du projet</h2>

    <!-- GRID DES CARTES -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">

      <!-- üîí SECURITY HEADERS -->
      {hasSecurityHeaders && (
        <div class="p-6 rounded-xl shadow-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700
     flex flex-col justify-center items-center text-center">

          <h3 class="text-xl font-semibold mb-3">Security Headers</h3>
          <span class={`px-4 py-2 rounded-full font-bold text-sm ${badgeColor(Number(projet.scores.security_headers) * 10)}`}>
            {projet.scores.security_headers}
          </span>
          <p class="opacity-70 text-sm mt-2">
            Analyse des en-t√™tes HTTP pour la s√©curit√© globale du site.
          </p>
        </div>
      )}

      <!-- üíª LIGHTHOUSE DESKTOP -->
      {hasLighthouseMobile && (
        <div class="p-6 rounded-xl shadow-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold justify-center mb-4 flex items-center gap-2">
            Lighthouse üíª Desktop
          </h3>

          <div class="space-y-3">
            {projet.scores.lighthouse.desktop.performance && (
              <div class="flex justify-between items-center">
                <span>Performance</span>
                <span class={`px-3 py-1 rounded-full ${badgeColor(projet.scores.lighthouse.desktop.performance)}`}>
                  {projet.scores.lighthouse.desktop.performance}
                </span>
              </div>
            )}

            {projet.scores.lighthouse.desktop.accessibility && (
              <div class="flex justify-between items-center">
                <span>Accessibilit√©</span>
                <span class={`px-3 py-1 rounded-full ${badgeColor(projet.scores.lighthouse.desktop.accessibility)}`}>
                  {projet.scores.lighthouse.desktop.accessibility}
                </span>
              </div>
            )}

            {projet.scores.lighthouse.desktop.best_practices && (
              <div class="flex justify-between items-center">
                <span>Best Practices</span>
                <span class={`px-3 py-1 rounded-full ${badgeColor(projet.scores.lighthouse.desktop.best_practices)}`}>
                  {projet.scores.lighthouse.desktop.best_practices}
                </span>
              </div>
            )}

            {projet.scores.lighthouse.desktop.seo && (
              <div class="flex justify-between items-center">
                <span>SEO</span>
                <span class={`px-3 py-1 rounded-full ${badgeColor(projet.scores.lighthouse.desktop.seo)}`}>
                  {projet.scores.lighthouse.desktop.seo}
                </span>
              </div>
            )}
          </div>
        </div>
      )}

      <!-- üì± LIGHTHOUSE MOBILE -->
      {projet.scores?.lighthouse?.mobile && (
        <div class="p-6 rounded-xl shadow-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold justify-center mb-4 flex items-center gap-2">
           Lighthouse üì± Mobile
          </h3>

          <div class="space-y-3">
            {projet.scores.lighthouse.mobile.performance && (
              <div class="flex justify-between items-center">
                <span>Performance</span>
                <span class={`px-3 py-1 rounded-full ${badgeColor(projet.scores.lighthouse.mobile.performance)}`}>
                  {projet.scores.lighthouse.mobile.performance}
                </span>
              </div>
            )}

            {projet.scores.lighthouse.mobile.accessibility && (
              <div class="flex justify-between items-center">
                <span>Accessibilit√©</span>
                <span class={`px-3 py-1 rounded-full ${badgeColor(projet.scores.lighthouse.mobile.accessibility)}`}>
                  {projet.scores.lighthouse.mobile.accessibility}
                </span>
              </div>
            )}

            {projet.scores.lighthouse.mobile.best_practices && (
              <div class="flex justify-between items-center">
                <span>Best Practices</span>
                <span class={`px-3 py-1 rounded-full ${badgeColor(projet.scores.lighthouse.mobile.best_practices)}`}>
                  {projet.scores.lighthouse.mobile.best_practices}
                </span>
              </div>
            )}

            {projet.scores.lighthouse.mobile.seo && (
              <div class="flex justify-between items-center">
                <span>SEO</span>
                <span class={`px-3 py-1 rounded-full ${badgeColor(projet.scores.lighthouse.mobile.seo)}`}>
                  {projet.scores.lighthouse.mobile.seo}
                </span>
              </div>
            )}
          </div>
        </div>
      )}

    </div>
  </div>
)}

    <!-- Vid√©os du projet -->
{projet.videos && (
  <div class="mt-20" data-aos="fade-up">
    <h2 class="text-2xl font-semibold text-center mb-6">Vid√©os de pr√©sentation</h2>

    <div
      class={hasOneVideo
        ? "grid grid-cols-1 gap-10 justify-items-center"
        : "grid grid-cols-1 gap-10"}
      data-aos="zoom-in"
    >

      {projet.videos.desktop && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
        <iframe
          class="w-full aspect-video"
          src={toEmbed(projet.videos.desktop)}
          title={`Vid√©o du projet : ${projet.title} ‚Äî Version Desktop`}
          loading="lazy"
          allowfullscreen
          ></iframe>
          <p class="text-center text-sm opacity-80 py-2">Version Desktop</p>
        </div>
      )}

      {projet.videos.tablet?.landscape && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
          <iframe
            class="w-full aspect-video"
            src={toEmbed(projet.videos.tablet.landscape)}
            title={`Vid√©o du projet : ${projet.title} ‚Äî Tablette (Paysage)`}
            loading="lazy"
            allowfullscreen
          ></iframe>

          <p class="text-center text-sm opacity-80 py-2">Tablette (Paysage)</p>
        </div>
      )}

      {projet.videos.tablet?.portrait && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
          <iframe
              class="w-full aspect-video"
              src={toEmbed(projet.videos.tablet.portrait)}
              title={`Vid√©o du projet : ${projet.title} ‚Äî Tablette (Portrait)`}
              loading="lazy"
              allowfullscreen
            ></iframe>

          <p class="text-center text-sm opacity-80 py-2">Tablette (Portrait)</p>
        </div>
      )}

      {projet.videos.mobile?.landscape && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
          <iframe
            class="w-full aspect-video"
            src={toEmbed(projet.videos.mobile.landscape)}
            title={`Vid√©o du projet : ${projet.title} ‚Äî Mobile (Paysage)`}
            loading="lazy"
            allowfullscreen
          ></iframe>
          <p class="text-center text-sm opacity-80 py-2">Mobile (Paysage)</p>
        </div>
      )}

      {projet.videos.mobile?.portrait && projet.videos.mobile.portrait !== "" && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
          <iframe
            class="w-full aspect-video"
            src={toEmbed(projet.videos.mobile.portrait)}
            title={`Vid√©o du projet : ${projet.title} ‚Äî Mobile (Portrait)`}
            loading="lazy"
            allowfullscreen
          ></iframe>
          <p class="text-center text-sm opacity-80 py-2">Mobile (Portrait)</p>
        </div>
      )}

    </div>
  </div>
)}

    <!-- Galerie / screenshots si existants -->
    {projet.images?.length > 0 && (
      <div data-aos="fade-up">
        <h2 class="text-2xl font-semibold mb-4">Galerie</h2>
        <div class="grid grid-cols-1 gap-6">
          {projet.images.map((img) => (
            <div class="rounded-xl overflow-hidden shadow-lg">
              <Image
                src={img}
                alt="Screenshot du projet"
                width={800}
                height={600}
                class="w-full object-cover"
                loading="lazy"
              />
            </div>
          ))}
        </div>
      </div>
    )}
  
  <div class="flex justify-center mt-12">
  <Button variant="retour" href="/projects/page/1">
    ‚Üê Retour √† la liste des projets
  </Button>
</div>
    </div>
  </div>
</ProjectsLayout> 

<style>
  /* Container principal de la page */
  .project-page {
    padding-inline: 1.5rem;
  }

  /* Container principal de la description */
  .project-description {
    text-align: left;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Titres h4 */
  .project-description :global(h4) {
    font-size: 1.8rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
    text-align: center;
  }

  /* Paragraphes */
  .project-description :global(p) {
    margin: 1rem 0;
    font-size: clamp(1.1rem, 3vw, 1.35rem);
    font-weight: 300;
    line-height: 1.6;
    text-align: center;
  }

  /* Listes UL - CORRECTION PRINCIPALE */
  .project-description :global(ul) {
    display: block;
    list-style-type: disc;
    list-style-position: outside;
    margin: 1rem 0;
    padding-left: 2rem;
    font-size: clamp(1.1rem, 3vw, 1.35rem);
  }

  /* Items de liste */
  .project-description :global(li) {
    display: list-item;
    margin: 0.5rem 0;
    line-height: 1.6;
  }

  /* Texte en gras */
  .project-description :global(strong) {
    font-weight: 700;
  }

  /* Texte en italique */
  .project-description :global(em) {
    font-style: italic;
  }

  @media (max-width: 640px) {
    .project-page {
      padding-inline: 1.25rem;
    }
    .project-description :global(p),
    .project-description :global(ul),
    .project-description :global(li) {
      text-align: left;
    }
  }

</style>
