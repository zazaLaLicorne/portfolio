---
import { Image } from "astro:assets";
import projects from "@/data/projects.json";
import ProjectsLayout from "@/layouts/ProjectsLayout.astro";
import Button from "@/components/Button.astro";
import { getTechIcon } from "@/lib/techIcons";


// Générer toutes les routes statiques
export function getStaticPaths() {
  return projects.map((projet) => ({
    params: { slug: projet.slug },
    props: { projet },
  }));
}

// Récupérer le projet depuis les props
const { projet } = Astro.props;

if (!projet) {
  throw new Error(`Projet introuvable`);
}

// Pour les icônes tech du dossier public/icons
// function techIcon(name) {
//   return `/icons/${name.toLowerCase()}.webp`;
// }

// Pour la date plus lisible
const date = new Date(projet.date).toLocaleDateString("fr-FR", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const videosList = [
  projet.videos?.desktop,
  projet.videos?.tablet?.landscape,
  projet.videos?.tablet?.portrait,
  projet.videos?.mobile?.landscape,
  projet.videos?.mobile?.portrait
].filter(Boolean);

const hasOneVideo = videosList.length === 1;

function toEmbed(url) {
  if (!url) return "";

  if (url.includes("/shorts/")) {
    return url.replace("youtube.com/shorts/", "www.youtube.com/embed/");
  }

  if (url.includes("youtu.be/")) {
    return url.replace("youtu.be/", "www.youtube.com/embed/");
  }

  if (url.includes("watch?v=")) {
    return url.replace("watch?v=", "embed/");
  }

  return url;
}
---

<!-- PAGE PROJET -->
<ProjectsLayout>    
<div class="project-page">

  <div data-aos="fade-up" class="max-w-4xl mt-10 pt-10 mx-auto">

    <!-- Titre + badge -->
    <h1 class="text-4xl text-center font-bold mb-4">{projet.title}</h1>

   {projet.badge && (
  <div class="flex justify-center">
    <span class="inline-block bg-accent text-white px-3 py-1 rounded-lg mb-6">
      {projet.badge}
    </span>
  </div>
)}

    <p class="opacity-80 mb-10 text-center text-sm">
      Projet publié le {date}
    </p>

    <!-- Thumbnail -->
    <div data-aos="zoom-in" class="rounded-xl overflow-hidden shadow-lg mb-12">
      <Image
        src={projet.thumbnail}
        alt={projet.title}
        width={1200}
        height={700}
        loading="eager"
        class="w-full h-auto object-cover"
      />
    </div>

    <!-- Description -->
   <div data-aos="fade-up" class="project-description mb-12" set:html={projet.description}>

   </div>

    <!-- Tech Stack -->
    <div data-aos="fade-up" class="mb-16">
      <h2 class="text-2xl font-semibold text-center mb-4">Technologies utilisées</h2>
      <div class="flex flex-wrap justify-center gap-6">
        {projet.techs.map((tech) => (
          <div class="flex flex-col gap-3 items-center" data-aos="zoom-in" data-aos-delay="100">
            <Image
              src={getTechIcon(tech)}
              alt={tech}
              width={40}
              height={40}
              class="w-10 h-10 object-contain"
              loading="lazy"
            />
            <span class="text-lg">{tech}</span>
          </div>
        ))}
      </div>
    </div>
        <!-- Liens externes -->
   {(projet.project_url || projet.github_url) && (
  <div data-aos="fade-up" class="flex flex-col text-center gap-6 mb-20">
    <h2 class="text-2xl font-semibold mb-4">Liens du projet</h2>

    {projet.project_url && (
      <Button variant="projet" href={projet.project_url} target="_blank">
        Voir le site
      </Button>
    )}

    {projet.github_url && (
      <Button variant="projet" href={projet.github_url} target="_blank">
        <img src="/icons/github.webp" alt="GitHub" class="w-5 h-5" />
        Voir le code
      </Button>
    )}
  </div>
)}

    <!-- Notes -->
   {projet.scores?.lighthouse && projet.scores?.security_headers && (
    <div class="mt-20" data-aos="fade-up">
      <h2 class="text-2xl font-semibold text-center mb-6">Scores du projet</h2>

    <!-- TABLEAU SECURITY HEADERS -->
      <div class="overflow-x-auto justify-self-center mb-10">
        <table class="table-auto border-collapse rounded-xl overflow-hidden shadow-lg">
          <thead class="bg-gray-200 dark:bg-gray-700">
            <tr>
              <th class="p-4 font-bold">Test</th>
              <th class="p-4  font-bold">Note</th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800">
            <tr class="border-t border-gray-300 dark:border-gray-700">
              <td class="p-4 font-medium">Security Headers</td>
              <td class="p-4 font-bold text-accent">
                {projet.scores.security_headers}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- TABLEAU LIGHTHOUSE -->
    <h3 class="text-xl font-semibold text-center mb-4">Lighthouse</h3>

    <div class="overflow-x-auto ">
      <table class="table-auto w-full border-collapse rounded-xl overflow-hidden shadow-lg">
        <thead class="bg-gray-200 dark:bg-gray-700">
          <tr>
            <th class="p-4 font-bold ">Plateforme</th>
            <th class="p-4 font-bold ">Performance</th>
            <th class="p-4 font-bold ">Accessibilité</th>
            <th class="p-4 font-bold ">Best Practices</th>
            <th class="p-4 font-bold ">SEO</th>
          </tr>
        </thead>

        <tbody class="text-center bg-white dark:bg-gray-800">

          <!-- DESKTOP -->
          <tr class="border-t border-gray-300 dark:border-gray-700">
            <td class="p-4 font-medium ">Desktop</td>
            <td class="p-4 ">{projet.scores.lighthouse.desktop.performance}</td>
            <td class="p-4 ">{projet.scores.lighthouse.desktop.accessibility}</td>
            <td class="p-4 ">{projet.scores.lighthouse.desktop.best_practices}</td>
            <td class="p-4 ">{projet.scores.lighthouse.desktop.seo}</td>
          </tr>

          <!-- MOBILE -->
          <tr class="border-t border-gray-300 dark:border-gray-700">
            <td class="p-4 font-medium ">Mobile</td>
            <td class="p-4 ">{projet.scores.lighthouse.mobile.performance}</td>
            <td class="p-4 ">{projet.scores.lighthouse.mobile.accessibility}</td>
            <td class="p-4 ">{projet.scores.lighthouse.mobile.best_practices}</td>
            <td class="p-4 ">{projet.scores.lighthouse.mobile.seo}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
)}

    <!-- Vidéos du projet -->
{projet.videos && (
  <div class="mt-20" data-aos="fade-up">
    <h2 class="text-2xl font-semibold text-center mb-6">Vidéos de présentation</h2>

    <div
      class={hasOneVideo
        ? "flex justify-center"
        : "grid grid-cols-1 md:grid-cols-2 gap-10"}
      data-aos="zoom-in"
    >

      {projet.videos.desktop && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
        <iframe
          class="w-full aspect-video"
          src={toEmbed(projet.videos.desktop)}
          title={`Vidéo du projet : ${projet.title} — Version Desktop`}
          loading="lazy"
          allowfullscreen
          ></iframe>
          <p class="text-center text-sm opacity-80 py-2">Version Desktop</p>
        </div>
      )}

      {projet.videos.tablet?.landscape && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
          <iframe
            class="w-full aspect-video"
            src={toEmbed(projet.videos.tablet.landscape)}
            title={`Vidéo du projet : ${projet.title} — Tablette (Paysage)`}
            loading="lazy"
            allowfullscreen
          ></iframe>

          <p class="text-center text-sm opacity-80 py-2">Tablette (Paysage)</p>
        </div>
      )}

      {projet.videos.tablet?.portrait && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
          <iframe
              class="w-full aspect-video"
              src={toEmbed(projet.videos.tablet.portrait)}
              title={`Vidéo du projet : ${projet.title} — Tablette (Portrait)`}
              loading="lazy"
              allowfullscreen
            ></iframe>

          <p class="text-center text-sm opacity-80 py-2">Tablette (Portrait)</p>
        </div>
      )}

      {projet.videos.mobile?.landscape && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
          <iframe
            class="w-full aspect-video"
            src={toEmbed(projet.videos.mobile.landscape)}
            title={`Vidéo du projet : ${projet.title} — Mobile (Paysage)`}
            loading="lazy"
            allowfullscreen
          ></iframe>
          <p class="text-center text-sm opacity-80 py-2">Mobile (Paysage)</p>
        </div>
      )}

      {projet.videos.mobile?.portrait && projet.videos.mobile.portrait !== "" && (
        <div class="video-card rounded-xl overflow-hidden shadow-lg bg-black">
          <iframe
            class="w-full aspect-video"
            src={toEmbed(projet.videos.mobile.portrait)}
            title={`Vidéo du projet : ${projet.title} — Mobile (Portrait)`}
            loading="lazy"
            allowfullscreen
          ></iframe>
          <p class="text-center text-sm opacity-80 py-2">Mobile (Portrait)</p>
        </div>
      )}

    </div>
  </div>
)}

    <!-- Galerie / screenshots si existants -->
    {projet.images?.length > 0 && (
      <div data-aos="fade-up">
        <h2 class="text-2xl font-semibold mb-4">Galerie</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {projet.images.map((img) => (
            <div class="rounded-xl overflow-hidden shadow-lg">
              <Image
                src={img}
                alt="Screenshot du projet"
                width={800}
                height={600}
                class="w-full object-cover"
                loading="lazy"
              />
            </div>
          ))}
        </div>
      </div>
    )}
  
  <div class="flex justify-center mt-12">
  <Button variant="retour" href="/projects/page/1">
    ← Retour à la liste des projets
  </Button>
</div>
    </div>
  </div>
</ProjectsLayout> 

<style>
  /* Container principal de la description */
  .project-description {
    text-align: left;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Titres h4 */
  .project-description :global(h4) {
    font-size: 1.8rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
    text-align: center;
  }

  /* Paragraphes */
  .project-description :global(p) {
    margin: 1rem 0;
    font-size: 1.3rem;
    font-weight: 300;
    line-height: 1.6;
    text-align: center;
  }

  /* Listes UL - CORRECTION PRINCIPALE */
  .project-description :global(ul) {
    display: block;
    list-style-type: disc;
    list-style-position: outside;
    margin: 1rem 0;
    padding-left: 2rem;
    font-size: 1.3rem;
  }

  /* Items de liste */
  .project-description :global(li) {
    display: list-item;
    margin: 0.5rem 0;
    line-height: 1.6;
  }

  /* Texte en gras */
  .project-description :global(strong) {
    font-weight: 700;
  }

  /* Texte en italique */
  .project-description :global(em) {
    font-style: italic;
  }

</style>